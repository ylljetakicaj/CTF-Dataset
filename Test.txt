using System;
using System.IO;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Threading.Tasks;
using System.Web.Script.Serialization;

public class InDocClient
{
    private readonly HttpClient _http;
    private readonly JavaScriptSerializer _serializer = new JavaScriptSerializer();

    public InDocClient(string baseUrl, string username, string password)
    {
        _http = new HttpClient();
        _http.BaseAddress = new Uri(baseUrl);

        string auth = Convert.ToBase64String(Encoding.ASCII.GetBytes(username + ":" + password));
        _http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Basic", auth);
    }

    public async Task<string> CreateCaseFolderAsync(string clientId, string name, string surname)
    {
        var body = new
        {
            ParentId = "CLNT_PI",
            Key = "CLNT_PI_" + clientId,
            Name = clientId,
            DocumentTypeId = "CLNT",
            Metadata = new
            {
                Items = new object[]
                {
                    new { DataType = "Text", Key = "CLNTID", Name = "Client ID", Text = clientId },
                    new { DataType = "Text", Key = "NAME", Name = "Name", Text = name },
                    new { DataType = "Text", Key = "SRNM", Name = "Surname", Text = surname }
                }
            },
            IsCaseFolder = "true",
            AllowedDocumentTypes = new[] { "CLNT" },
            RenameIfExists = "true",
            OnBehalfOf = name + " " + surname,
            ReasonCode = "VPGL",
            ReasonBody = "Creating new case folder",
            ReasonType = "Administration"
        };

        string json = _serializer.Serialize(body);
        HttpContent content = new StringContent(json, Encoding.UTF8, "application/json");

        HttpResponseMessage response = await _http.PostAsync("/api/casefolder/create", content);

        if (!response.IsSuccessStatusCode)
            return null;

        string responseText = await response.Content.ReadAsStringAsync();

        try
        {
            var result = _serializer.Deserialize<dynamic>(responseText);
            return result["Id"];
        }
        catch
        {
            return null;
        }
    }

    public async Task<bool> UploadDocumentAsync(string caseFolderId, string filePath)
    {
        MultipartFormDataContent form = new MultipartFormDataContent();

        byte[] bytes = File.ReadAllBytes(filePath);
        ByteArrayContent fileContent = new ByteArrayContent(bytes);
        fileContent.Headers.ContentType = MediaTypeHeaderValue.Parse("application/pdf");

        form.Add(fileContent, "file", Path.GetFileName(filePath));
        form.Add(new StringContent(caseFolderId), "CaseFolderId");

        HttpResponseMessage response = await _http.PostAsync("/api/documents/upload", form);

        return response.IsSuccessStatusCode;
    }
}