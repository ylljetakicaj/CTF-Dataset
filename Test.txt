using Newtonsoft.Json.Linq;
using System;
using System.IO;
using System.Net.Http;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

class Program
{
    static void Main(string[] args)
    {
        Run().Wait();
    }

    static async Task Run()
    {
        string rootPath = @"C:\Clients";
        string apiBaseUrl = "https://your-indoc-edge-api-url.com";
        string username = "yourUsername";
        string password = "yourPassword";

        InDocClient client = new InDocClient(apiBaseUrl, username, password);

        foreach (string clientFolder in Directory.GetDirectories(rootPath))
        {
            string clientId = Path.GetFileName(clientFolder);
            string[] files = Directory.GetFiles(clientFolder);

            foreach (string file in files)
            {
                Tuple<string, string> nameData = ExtractNameSurname(file);
                string name = nameData.Item1;
                string surname = nameData.Item2;

                Console.WriteLine("Processing " + clientId + " → " + name + " " + surname);

                // 1. Create case folder
                string caseFolderId = await client.CreateCaseFolderAsync(clientId, name, surname);

                if (caseFolderId == null)
                {
                    Console.WriteLine("❌ Failed to create case folder");
                    continue;
                }

                // 2. Upload the document
                bool ok = await client.UploadDocumentAsync(caseFolderId, file);

                if (ok)
                    Console.WriteLine("✔ Document uploaded successfully\n");
                else
                    Console.WriteLine("❌ Failed to upload document\n");
            }
        }

        Console.WriteLine("---- FINISHED ----");
    }

    static Tuple<string, string> ExtractNameSurname(string filePath)
    {
        string fileName = Path.GetFileNameWithoutExtension(filePath);

        // Example: 17013222_FILAN_FISTEKU_Contract-17013222_Signed.pdf
        Match m = Regex.Match(fileName, @"^\d+_([A-Za-z]+)_([A-Za-z]+)_");

        if (m.Success)
            return Tuple.Create(m.Groups[1].Value, m.Groups[2].Value);

        return Tuple.Create("Unknown", "Unknown");
    }
}