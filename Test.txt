using System;
using System.Net.Http;
using System.Net.Http.Headers;
using System.IO;
using System.Text;
using System.Text.RegularExpressions;

class Program
{
    static void Main()
    {
        string apiUrl = "https://your-api-url";  // replace with your API URL
        string username = "YOUR_USERNAME";       // replace
        string password = "YOUR_PASSWORD";       // replace
        string clientsRootFolder = @"C:\Clients"; // replace with your folder path

        HttpClient client = new HttpClient();
        client.BaseAddress = new Uri(apiUrl);

        // Basic Auth
        string basicAuth = Convert.ToBase64String(Encoding.ASCII.GetBytes(username + ":" + password));
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Basic", basicAuth);

        string[] clientFolders = Directory.GetDirectories(clientsRootFolder);

        foreach (var folderPath in clientFolders)
        {
            string clientId = new DirectoryInfo(folderPath).Name;

            // Get first PDF file for name/surname
            string[] pdfFiles = Directory.GetFiles(folderPath, "*.pdf");
            if (pdfFiles.Length == 0) continue;

            string firstFileName = Path.GetFileNameWithoutExtension(pdfFiles[0]);

            // Example filename: 17013222_FILAN_FISTEKU_Contract
            string pattern = @"^\d+_([A-Z]+)_([A-Z]+)_";
            Match match = Regex.Match(firstFileName, pattern);
            string firstName = "Unknown";
            string lastName = "Unknown";
            if (match.Success && match.Groups.Count == 3)
            {
                firstName = match.Groups[1].Value;
                lastName = match.Groups[2].Value;
            }

            // -------------------- Manual JSON --------------------
            string json = "{";
            json += "\"ParentId\":\"CLNT_PI\",";
            json += "\"Key\":\"CLNT_PI_" + clientId + "\",";
            json += "\"Name\":\"" + clientId + "\",";
            json += "\"DocumentTypeId\":\"CLNT\",";
            json += "\"Metadata\":{ \"Items\":[";
            json += "{\"DataType\":\"Text\",\"Key\":\"CLNTID\",\"Name\":\"Client ID\",\"Text\":\"" + clientId + "\"},";
            json += "{\"DataType\":\"Text\",\"Key\":\"NAME\",\"Name\":\"Name\",\"Text\":\"" + firstName + "\"},";
            json += "{\"DataType\":\"Text\",\"Key\":\"SRNM\",\"Name\":\"Surname\",\"Text\":\"" + lastName + "\"},";
            json += "{\"DataType\":\"Text\",\"Key\":\"CLNTTYP\",\"Name\":\"Client type\",\"Text\":\"PI\"},";
            json += "{\"DataType\":\"Composite\",\"Key\":\"DCMTCDANDTTL\",\"Name\":\"Document code and title\",";
            json += "\"Composite\":{\"Items\":[";
            json += "{\"DataType\":\"Text\",\"Key\":\"CODE\",\"Name\":\"Code\",\"Text\":\"3\"},";
            json += "{\"DataType\":\"Text\",\"Key\":\"TTL\",\"Name\":\"Title\",\"Text\":\"Consent for access and processing of personal data\"}";
            json += "]}}";
            json += "]},"; // end metadata
            json += "\"IsCaseFolder\":\"true\",";
            json += "\"AllowedDocumentTypes\":[\"CLNT\"],";
            json += "\"RenameIfExists\":\"true\",";
            json += "\"OnBehalfOf\":\"" + firstName + " " + lastName + "\",";
            json += "\"ReasonCode\":\"VPGL\",";
            json += "\"ReasonBody\":\"Creating new case folder\",";
            json += "\"ReasonType\":\"Administration\"";
            json += "}";

            // -------------------- POST Request --------------------
            var content = new StringContent(json, Encoding.UTF8, "application/json");
            HttpResponseMessage response = client.PostAsync("/api/casefolder/create", content).Result;

            if (response.IsSuccessStatusCode)
            {
                string respJson = response.Content.ReadAsStringAsync().Result;
                Console.WriteLine("Folder created for client " + clientId);
                Console.WriteLine(respJson);
            }
            else
            {
                Console.WriteLine("Failed for client " + clientId);
                Console.WriteLine(response.StatusCode);
                Console.WriteLine(response.Content.ReadAsStringAsync().Result);
            }
        }

        Console.WriteLine("All done.");
    }
}