using System;
using System.IO;
using System.Net;
using System.Text;

class Program
{
    static string sessionCookie = "";

    static void Main()
    {
        ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;

        Console.WriteLine("Authenticating...");

        if (!Authenticate())
        {
            Console.WriteLine("Auth failed.");
            return;
        }

        Console.WriteLine("Auth OK. Cookie: " + sessionCookie);

        Console.WriteLine("Sending case folder...");
        SendCaseFolder();
    }

    static bool Authenticate()
    {
        string authUrl = "https://YOUR-AUTH-ENDPOINT-HERE";

        var req = (HttpWebRequest)WebRequest.Create(authUrl);
        req.Method = "POST";
        req.ContentType = "application/json";

        string authJson = "{\"username\":\"YOURUSER\",\"password\":\"YOURPASS\"}";
        byte[] data = Encoding.UTF8.GetBytes(authJson);

        using (var stream = req.GetRequestStream())
            stream.Write(data, 0, data.Length);

        try
        {
            var resp = (HttpWebResponse)req.GetResponse();

            // Retrieve cookie
            if (resp.Headers["Set-Cookie"] != null)
            {
                string raw = resp.Headers["Set-Cookie"];
                sessionCookie = raw.Split(';')[0]; // ".ASPXAUTH=xxxxx"
            }
            else
            {
                Console.WriteLine("Server did not provide cookie!");
                return false;
            }

            return true;
        }
        catch (WebException ex)
        {
            Console.WriteLine("AUTH EXCEPTION: " + ex.Message);
            return false;
        }
    }


    static void SendCaseFolder()
    {
        string url = "https://YOUR-API-ENDPOINT/FOLDER";

        var req = (HttpWebRequest)WebRequest.Create(url);
        req.Method = "POST";
        req.ContentType = "application/json";

        // Add session cookie
        req.Headers["Cookie"] = sessionCookie;

        // Your JSON string EXACTLY as IndoEdge expects
        string json =
        @"{
          ""ParentId"": ""CLNT_PI"",
          ""Key"": ""CLNT_PI_1234567"",
          ""Name"": ""1234567"",
          ""DocumentTypeId"": ""CLNT"",
          ""Metadata"": {
            ""Items"": [
              { ""DataType"": ""Text"", ""Key"": ""CLNTID"", ""Name"": ""Client ID"", ""Text"": ""1234567"" },
              { ""DataType"": ""Text"", ""Key"": ""NAME"", ""Name"": ""Name"", ""Text"": ""Filan"" },
              { ""DataType"": ""Text"", ""Key"": ""SRNM"", ""Name"": ""Surname"", ""Text"": ""Fisteku"" },
              {
                ""DataType"": ""Composite"",
                ""Key"": ""DCMTCDANDTTL"",
                ""Name"": ""Document code and title"",
                ""Composite"": {
                  ""Items"": [
                    { ""DataType"": ""Text"", ""Key"": ""CODE"", ""Name"": ""Code"", ""Text"": ""3"" },
                    { ""DataType"": ""Text"", ""Key"": ""TTL"", ""Name"": ""Title"", ""Text"": ""Consent for access and processing of personal data"" }
                  ]
                }
              }
            ]
          },
          ""IsCaseFolder"": ""true"",
          ""AllowedDocumentTypes"": [ ""CLNT"" ],
          ""RenameIfExists"": ""true"",
          ""OnBehalfOf"": ""Filan Fisteku"",
          ""ReasonCode"": ""VPGL"",
          ""ReasonBody"": ""Creating new case folder"",
          ""ReasonType"": ""Administration""
        }";

        byte[] data = Encoding.UTF8.GetBytes(json);

        using (var stream = req.GetRequestStream())
            stream.Write(data, 0, data.Length);

        try
        {
            var resp = (HttpWebResponse)req.GetResponse();
            Console.WriteLine("SUCCESS: " + resp.StatusCode);
        }
        catch (WebException ex)
        {
            var resp = ex.Response as HttpWebResponse;

            if (resp != null)
            {
                using (var reader = new StreamReader(resp.GetResponseStream()))
                {
                    string error = reader.ReadToEnd();
                    Console.WriteLine("SERVER ERROR: " + error);
                }

                Console.WriteLine("STATUS: " + resp.StatusCode);
            }
            else
            {
                Console.WriteLine("EXCEPTION: " + ex.Message);
            }
        }
    }
}