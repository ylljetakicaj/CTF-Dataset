using System.Net.Http.Headers;
using System.Text;
using System.Text.Json;
using System.Text.RegularExpressions;

class Program
{
    static async Task Main(string[] args)
    {
        string rootPath = @"C:\Clients";  // folders containing ClientID
        string apiBaseUrl = "https://your-indoc-edge-api-url.com";
        string username = "yourUsername";
        string password = "yourPassword";

        var client = new InDocClient(apiBaseUrl, username, password);

        foreach (var clientFolder in Directory.GetDirectories(rootPath))
        {
            string clientId = Path.GetFileName(clientFolder);

            // Get the two documents inside the folder
            var files = Directory.GetFiles(clientFolder);

            foreach (var file in files)
            {
                var (name, surname) = ExtractNameSurname(file);
                Console.WriteLine($"Processing {clientId} → {name} {surname}");

                // 1. Create Case Folder
                var caseFolderId = await client.CreateCaseFolderAsync(
                    clientId, name, surname
                );

                if (caseFolderId == null)
                {
                    Console.WriteLine("❌ Failed to create case folder.");
                    continue;
                }

                // 2. Upload Document
                bool uploaded = await client.UploadDocumentAsync(caseFolderId, file);

                if (uploaded)
                    Console.WriteLine("✔ Document uploaded successfully\n");
                else
                    Console.WriteLine("❌ Document upload failed\n");
            }
        }

        Console.WriteLine("---- FINISHED ----");
    }

    static (string Name, string Surname) ExtractNameSurname(string filePath)
    {
        // Example:
        // 17013222_FILAN_FISTEKU_Contract-17013222_Signed.pdf
        string fileName = Path.GetFileNameWithoutExtension(filePath);

        var match = Regex.Match(fileName, @"^\d+_([A-Za-z]+)_([A-Za-z]+)_");

        if (match.Success)
            return (match.Groups[1].Value, match.Groups[2].Value);

        return ("Unknown", "Unknown");
    }
}