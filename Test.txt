using System;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Collections.Generic;
using System.IO;
using System.Text.RegularExpressions;
using System.Runtime.Serialization.Json;

// ---------------------- Models ----------------------
public class CreateFolderModel
{
    public string ParentId { get; set; }
    public string Key { get; set; }
    public string Name { get; set; }
    public string DocumentTypeId { get; set; }
    public Metadata Metadata { get; set; }
    public string IsCaseFolder { get; set; }
    public string[] AllowedDocumentTypes { get; set; }
    public string RenameIfExists { get; set; }
    public string OnBehalfOf { get; set; }
    public string ReasonCode { get; set; }
    public string ReasonBody { get; set; }
    public string ReasonType { get; set; }
}

public class Metadata
{
    public List<MetadataItem> Items { get; set; }
}

public class MetadataItem
{
    public string DataType { get; set; }
    public string Key { get; set; }
    public string Name { get; set; }
    public string Text { get; set; }
    public CompositeMetadata Composite { get; set; }
}

public class CompositeMetadata
{
    public List<CompositeItem> Items { get; set; }
}

public class CompositeItem
{
    public string DataType { get; set; }
    public string Key { get; set; }
    public string Name { get; set; }
    public string Text { get; set; }
}

// ---------------------- Program ----------------------
class Program
{
    static void Main()
    {
        // Environment variables
        string apiUrl = "https://your-api-url";  // replace
        string username = "YOUR_USERNAME";       // replace
        string password = "YOUR_PASSWORD";       // replace
        string clientsRootFolder = @"C:\Clients"; // replace with your folder path

        HttpClient client = new HttpClient();
        client.BaseAddress = new Uri(apiUrl);

        // Basic Auth
        string basicAuth = Convert.ToBase64String(Encoding.ASCII.GetBytes(username + ":" + password));
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Basic", basicAuth);

        string[] clientFolders = Directory.GetDirectories(clientsRootFolder);

        foreach (var folderPath in clientFolders)
        {
            string clientId = new DirectoryInfo(folderPath).Name;

            // Get first PDF file for name/surname
            string[] pdfFiles = Directory.GetFiles(folderPath, "*.pdf");
            if (pdfFiles.Length == 0) continue;

            string firstFileName = Path.GetFileNameWithoutExtension(pdfFiles[0]);
            string pattern = @"^\d+_([A-Z]+)_([A-Z]+)_";
            Match match = Regex.Match(firstFileName, pattern);
            string firstName = "Unknown";
            string lastName = "Unknown";
            if (match.Success && match.Groups.Count == 3)
            {
                firstName = match.Groups[1].Value;
                lastName = match.Groups[2].Value;
            }

            // Prepare folder object
            var folder = new CreateFolderModel
            {
                ParentId = "CLNT_PI",
                Key = "CLNT_PI_" + clientId,
                Name = clientId,
                DocumentTypeId = "CLNT",
                Metadata = new Metadata
                {
                    Items = new List<MetadataItem>
                    {
                        new MetadataItem { DataType = "Text", Key = "CLNTID", Name = "Client ID", Text = clientId },
                        new MetadataItem { DataType = "Text", Key = "NAME", Name = "Name", Text = firstName },
                        new MetadataItem { DataType = "Text", Key = "SRNM", Name = "Surname", Text = lastName },
                        new MetadataItem { DataType = "Text", Key = "CLNTTYP", Name = "Client type", Text = "PI" },
                        new MetadataItem
                        {
                            DataType = "Composite",
                            Key = "DCMTCDANDTTL",
                            Name = "Document code and title",
                            Composite = new CompositeMetadata
                            {
                                Items = new List<CompositeItem>
                                {
                                    new CompositeItem { DataType = "Text", Key = "CODE", Name = "Code", Text = "3" },
                                    new CompositeItem { DataType = "Text", Key = "TTL", Name = "Title", Text = "Consent for access and processing of personal data" }
                                }
                            }
                        }
                    }
                },
                IsCaseFolder = "true",
                AllowedDocumentTypes = new[] { "CLNT" },
                RenameIfExists = "true",
                OnBehalfOf = firstName + " " + lastName,
                ReasonCode = "VPGL",
                ReasonBody = "Creating new case folder",
                ReasonType = "Administration"
            };

            // Serialize using DataContractJsonSerializer
            string json;
            using (var ms = new MemoryStream())
            {
                var serializer = new DataContractJsonSerializer(typeof(CreateFolderModel));
                serializer.WriteObject(ms, folder);
                ms.Position = 0;
                using (var sr = new StreamReader(ms))
                {
                    json = sr.ReadToEnd();
                }
            }

            // Send POST request
            var content = new StringContent(json, Encoding.UTF8, "application/json");
            HttpResponseMessage response = client.PostAsync("/api/casefolder/create", content).Result;

            if (response.IsSuccessStatusCode)
            {
                string respJson = response.Content.ReadAsStringAsync().Result;
                Console.WriteLine("Folder created for client " + clientId);
                Console.WriteLine(respJson);
            }
            else
            {
                Console.WriteLine("Failed for client " + clientId);
                Console.WriteLine(response.StatusCode);
                Console.WriteLine(response.Content.ReadAsStringAsync().Result);
            }
        }

        Console.WriteLine("All done.");
    }
}