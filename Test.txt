using System;
using System.Collections.Generic;
using System.IO;
using System.Net;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Text.RegularExpressions;

class Program
{
    static void Main()
    {
        // Force TLS 1.2
        ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;

        // Optional: bypass SSL validation for testing only (remove in production)
        ServicePointManager.ServerCertificateValidationCallback = (sender, cert, chain, sslPolicyErrors) => true;

        // ------------------- Config -------------------
        string authUrl = "https://your-indoc-edge-api-url/authenticate"; // Replace with actual auth service URL
        string apiBaseUrl = "https://your-indoc-edge-api-url";           // Base URL for API requests
        string username = "YOUR_USERNAME";
        string password = "YOUR_PASSWORD";
        string clientsRootFolder = @"C:\Clients";                       // Local path with client folders

        // ------------------- HttpClient with CookieContainer -------------------
        var handler = new HttpClientHandler();
        handler.CookieContainer = new CookieContainer();
        HttpClient client = new HttpClient(handler);

        // ------------------- Authenticate -------------------
        var authContent = new FormUrlEncodedContent(new[]
        {
            new KeyValuePair<string, string>("username", username),
            new KeyValuePair<string, string>("password", password)
        });

        HttpResponseMessage authResponse = client.PostAsync(authUrl, authContent).Result;

        if (!authResponse.IsSuccessStatusCode)
        {
            Console.WriteLine("Authentication failed: " + authResponse.StatusCode);
            Console.WriteLine(authResponse.Content.ReadAsStringAsync().Result);
            return;
        }

        Console.WriteLine("Authentication successful. Session cookie obtained.");

        // ------------------- Iterate client folders -------------------
        string[] clientFolders = Directory.GetDirectories(clientsRootFolder);

        foreach (var folderPath in clientFolders)
        {
            string clientId = new DirectoryInfo(folderPath).Name;

            // Get first PDF file for name/surname
            string[] pdfFiles = Directory.GetFiles(folderPath, "*.pdf");
            if (pdfFiles.Length == 0) continue;

            string firstFileName = Path.GetFileNameWithoutExtension(pdfFiles[0]);

            // Example filename: 17013222_FILAN_FISTEKU_Contract
            string pattern = @"^\d+_([A-Z]+)_([A-Z]+)_";
            Match match = Regex.Match(firstFileName, pattern);
            string firstName = "Unknown";
            string lastName = "Unknown";
            if (match.Success && match.Groups.Count == 3)
            {
                firstName = match.Groups[1].Value;
                lastName = match.Groups[2].Value;
            }

            // ------------------- Build manual JSON -------------------
            string folderJson = "{";
            folderJson += "\"ParentId\":\"CLNT_PI\",";
            folderJson += "\"Key\":\"CLNT_PI_" + clientId + "\",";
            folderJson += "\"Name\":\"" + clientId + "\",";
            folderJson += "\"DocumentTypeId\":\"CLNT\",";
            folderJson += "\"Metadata\":{\"Items\":[";
            folderJson += "{\"DataType\":\"Text\",\"Key\":\"CLNTID\",\"Name\":\"Client ID\",\"Text\":\"" + clientId + "\"},";
            folderJson += "{\"DataType\":\"Text\",\"Key\":\"NAME\",\"Name\":\"Name\",\"Text\":\"" + firstName + "\"},";
            folderJson += "{\"DataType\":\"Text\",\"Key\":\"SRNM\",\"Name\":\"Surname\",\"Text\":\"" + lastName + "\"},";
            folderJson += "{\"DataType\":\"Text\",\"Key\":\"CLNTTYP\",\"Name\":\"Client type\",\"Text\":\"PI\"},";
            folderJson += "{\"DataType\":\"Composite\",\"Key\":\"DCMTCDANDTTL\",\"Name\":\"Document code and title\",";
            folderJson += "\"Composite\":{\"Items\":[";
            folderJson += "{\"DataType\":\"Text\",\"Key\":\"CODE\",\"Name\":\"Code\",\"Text\":\"3\"},";
            folderJson += "{\"DataType\":\"Text\",\"Key\":\"TTL\",\"Name\":\"Title\",\"Text\":\"Consent for access and processing of personal data\"}";
            folderJson += "]}}";
            folderJson += "]},"; // end metadata
            folderJson += "\"IsCaseFolder\":\"true\",";
            folderJson += "\"AllowedDocumentTypes\":[\"CLNT\"],";
            folderJson += "\"RenameIfExists\":\"true\",";
            folderJson += "\"OnBehalfOf\":\"" + firstName + " " + lastName + "\",";
            folderJson += "\"ReasonCode\":\"VPGL\",";
            folderJson += "\"ReasonBody\":\"Creating new case folder\",";
            folderJson += "\"ReasonType\":\"Administration\"";
            folderJson += "}";

            // ------------------- POST case folder -------------------
            string folderEndpoint = apiBaseUrl + "/api/casefolder/create"; // replace with correct endpoint
            var content = new StringContent(folderJson, Encoding.UTF8, "application/json");

            HttpResponseMessage response = client.PostAsync(folderEndpoint, content).Result;

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("Folder created for client " + clientId);
                Console.WriteLine(response.Content.ReadAsStringAsync().Result);
            }
            else
            {
                Console.WriteLine("Failed for client " + clientId);
                Console.WriteLine(response.StatusCode);
                Console.WriteLine(response.Content.ReadAsStringAsync().Result);
            }
        }

        Console.WriteLine("All done.");
    }
}