using System;
using System.IO;
using System.Net;
using System.Text;

namespace IndocUploader
{
    class Program
    {
        static void Main(string[] args)
        {
            // Required by IndocEdge
            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;

            string apiBase = "https://YOUR-INDOC-EDGE";
            string authUrl = apiBase + "/auth/login";
            string caseFolderUrl = apiBase + "/api/folder/create";
            string documentUrl = apiBase + "/api/document/create";

            string username = "yourUser";
            string password = "yourPass";

            string rootFolder = @"C:\Docs\1234567";

            string clientId = new DirectoryInfo(rootFolder).Name;

            string firstFile = Directory.GetFiles(rootFolder)[0];
            string fileName = Path.GetFileNameWithoutExtension(firstFile);
            string[] parts = fileName.Split('_');

            string name = parts[1];
            string surname = parts[2];

            Console.WriteLine("Client: " + clientId + " " + name + " " + surname);

            string sessionCookie = Authenticate(authUrl, username, password);

            if (sessionCookie == null)
            {
                Console.WriteLine("Authentication failed.");
                return;
            }

            Console.WriteLine("Auth OK. Cookie: " + sessionCookie);

            // ---------------------------------------
            // MANUAL JSON FOR CASE FOLDER
            // ---------------------------------------
            string jsonCase =
                "{ " +
                "\"ParentId\":\"CLNT_PI\"," +
                "\"Key\":\"CLNT_PI_" + clientId + "\"," +
                "\"Name\":\"" + clientId + "\"," +
                "\"DocumentTypeId\":\"CLNT\"," +

                "\"Metadata\":{" +
                "\"Items\":[" +
                    "{ \"DataType\":\"Text\",\"Key\":\"CLNTID\",\"Name\":\"Client ID\",\"Text\":\"" + clientId + "\" }," +
                    "{ \"DataType\":\"Text\",\"Key\":\"NAME\",\"Name\":\"Name\",\"Text\":\"" + name + "\" }," +
                    "{ \"DataType\":\"Text\",\"Key\":\"SRNM\",\"Name\":\"Surname\",\"Text\":\"" + surname + "\" }," +
                    "{ \"DataType\":\"Text\",\"Key\":\"CLNTTYP\",\"Name\":\"Client type\",\"Text\":\"PI\" }," +

                    "{ \"DataType\":\"Composite\",\"Key\":\"DCMTCDANDTTL\",\"Name\":\"Document code and title\", " +
                        "\"Composite\":{ \"Items\":[" +
                            "{ \"DataType\":\"Text\",\"Key\":\"CODE\",\"Name\":\"Code\",\"Text\":\"3\" }," +
                            "{ \"DataType\":\"Text\",\"Key\":\"TTL\",\"Name\":\"Title\",\"Text\":\"Consent for access and processing of personal data\" }" +
                        "] }" +
                    "}" +
                "]" +
                "}," +

                "\"IsCaseFolder\":\"true\"," +
                "\"AllowedDocumentTypes\":[\"CLNT\"]," +
                "\"RenameIfExists\":\"true\"," +
                "\"OnBehalfOf\":\"" + name + " " + surname + "\"," +
                "\"ReasonCode\":\"VPGL\"," +
                "\"ReasonBody\":\"Creating new case folder\"," +
                "\"ReasonType\":\"Administration\"" +
                "}";

            Console.WriteLine("\nSending CASE FOLDER...");
            string resultCase = PostJson(caseFolderUrl, jsonCase, sessionCookie);
            Console.WriteLine(resultCase);

            // ---------------------------------------
            // MANUAL JSON FOR DOCUMENT (NO UPLOAD)
            // ---------------------------------------
            string jsonDoc =
                "{ " +
                "\"ParentId\":\"DIGPI\"," +
                "\"Key\":\"" + clientId + "-CONSENT.pdf\"," +
                "\"Name\":\"Consent document\"," +
                "\"ClassificationClassId\":\"\"," +
                "\"DocumentTypeId\":\"PRDCTRLT\"," +

                "\"Metadata\":{" +
                "\"Items\":[" +
                    "{ \"DataType\":\"Text\",\"Key\":\"CLNTID\",\"Name\":\"Client ID\",\"Text\":\"" + clientId + "\" }," +
                    "{ \"DataType\":\"Text\",\"Key\":\"NAME\",\"Name\":\"Name\",\"Text\":\"" + name + "\" }," +
                    "{ \"DataType\":\"Text\",\"Key\":\"SRNM\",\"Name\":\"Surname\",\"Text\":\"" + surname + "\" }," +
                    "{ \"DataType\":\"Text\",\"Key\":\"CLNTTYP\",\"Name\":\"Client type\",\"Text\":\"PI\" }," +

                    "{ \"DataType\":\"Composite\",\"Key\":\"DCMTCDANDTTL\",\"Name\":\"Document code and title\", " +
                        "\"Composite\":{ \"Items\":[" +
                            "{ \"DataType\":\"Text\",\"Key\":\"CODE\",\"Name\":\"Code\",\"Text\":\"82\" }," +
                            "{ \"DataType\":\"Text\",\"Key\":\"TTL\",\"Name\":\"Title\",\"Text\":\"Standard information form for consumer credit\" }" +
                        "] }" +
                    "}," +

                    "{ \"DataType\":\"Text\",\"Key\":\"CNFONTLYLVL\",\"Name\":\"Confidentiality level\",\"Text\":\"Internal\" }," +
                    "{ \"DataType\":\"Text\",\"Key\":\"STTS\",\"Name\":\"Status\",\"Text\":\"Active\" }," +
                    "{ \"DataType\":\"Text\",\"Key\":\"CRTDBY\",\"Name\":\"Created by\",\"Text\":\"Viljete Kicaj\" }" +
                "]" +
                "}," +

                "\"IsCaseFolder\":\"true\"," +
                "\"AllowedDocumentTypes\":[\"CLNT\"]," +
                "\"RenameIfExists\":\"true\"," +
                "\"OnBehalfOf\":\"" + name + " " + surname + "\"," +
                "\"ReasonCode\":\"VPGL\"," +
                "\"ReasonBody\":\"Creating new case folder\"," +
                "\"ReasonType\":\"Lookup\"" +
                "}";

            Console.WriteLine("\nSending DOCUMENT...");
            string resultDoc = PostJson(documentUrl, jsonDoc, sessionCookie);
            Console.WriteLine(resultDoc);
        }


        // ---------------- AUTH ----------------
        static string Authenticate(string url, string user, string pass)
        {
            try
            {
                string data = "username=" + user + "&password=" + pass;
                byte[] bytes = Encoding.UTF8.GetBytes(data);

                HttpWebRequest req = (HttpWebRequest)WebRequest.Create(url);
                req.Method = "POST";
                req.ContentType = "application/x-www-form-urlencoded";
                req.ContentLength = bytes.Length;

                using (var reqStream = req.GetRequestStream())
                    reqStream.Write(bytes, 0, bytes.Length);

                HttpWebResponse resp = (HttpWebResponse)req.GetResponse();

                return resp.Headers["Set-Cookie"];
            }
            catch (Exception ex)
            {
                Console.WriteLine("Auth Error: " + ex.Message);
                return null;
            }
        }

        // ---------------- POST JSON ----------------
        static string PostJson(string url, string json, string cookie)
        {
            try
            {
                byte[] bytes = Encoding.UTF8.GetBytes(json);

                HttpWebRequest req = (HttpWebRequest)WebRequest.Create(url);
                req.Method = "POST";
                req.ContentType = "application/json";
                req.Headers.Add("Cookie", cookie);
                req.ContentLength = bytes.Length;

                using (var reqStream = req.GetRequestStream())
                    reqStream.Write(bytes, 0, bytes.Length);

                HttpWebResponse resp = (HttpWebResponse)req.GetResponse();
                using (var reader = new StreamReader(resp.GetResponseStream()))
                    return reader.ReadToEnd();
            }
            catch (Exception ex)
            {
                return "Error: " + ex.Message;
            }
        }
    }
}