using System;
using System.IO;
using System.Net;
using System.Text;
using System.Web.Script.Serialization;

namespace IndocUploader
{
    class Program
    {
        static void Main(string[] args)
        {
            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;

            string apiBase = "https://YOUR-INDOC-EDGE";
            string authUrl = apiBase + "/auth/login";
            string caseFolderUrl = apiBase + "/api/folder/create";
            string documentUrl = apiBase + "/api/document/create";

            string username = "yourUser";
            string password = "yourPass";

            string rootFolder = @"C:\Docs\1234567";

            // Extract client ID from folder name
            string clientId = new DirectoryInfo(rootFolder).Name;

            // Extract name + surname from first file
            string firstFile = Directory.GetFiles(rootFolder)[0];
            string fileName = Path.GetFileNameWithoutExtension(firstFile);

            // Expected format: ID_NAME_SURNAME_...
            string[] parts = fileName.Split('_');

            string name = parts[1];
            string surname = parts[2];

            Console.WriteLine("Client:");
            Console.WriteLine(clientId + " " + name + " " + surname);

            // Authenticate and get session cookie
            string sessionCookie = Authenticate(authUrl, username, password);

            if (sessionCookie == null)
            {
                Console.WriteLine("Authentication failed.");
                return;
            }

            Console.WriteLine("Auth OK. Cookie: " + sessionCookie);

            // Build Case Folder POST JSON
            var caseFolderObj = new
            {
                ParentId = "CLNT_PI",
                Key = "CLNT_PI_" + clientId,
                Name = clientId,
                DocumentTypeId = "CLNT",
                Metadata = new
                {
                    Items = new object[]
                    {
                        new { DataType="Text", Key="CLNTID", Name="Client ID", Text=clientId },
                        new { DataType="Text", Key="NAME", Name="Name", Text=name },
                        new { DataType="Text", Key="SRNM", Name="Surname", Text=surname },
                        new { DataType="Text", Key="CLNTTYP", Name="Client type", Text="PI" },

                        new {
                            DataType="Composite",
                            Key="DCMTCDANDTTL",
                            Name="Document code and title",
                            Composite = new {
                                Items = new object[]
                                {
                                    new { DataType="Text", Key="CODE", Name="Code", Text="3" },
                                    new { DataType="Text", Key="TTL", Name="Title", Text="Consent for access and processing of personal data" }
                                }
                            }
                        }
                    }
                },
                IsCaseFolder = "true",
                AllowedDocumentTypes = new string[] { "CLNT" },
                RenameIfExists = "true",
                OnBehalfOf = name + " " + surname,
                ReasonCode = "VPGL",
                ReasonBody = "Creating new case folder",
                ReasonType = "Administration"
            };

            string jsonCase = new JavaScriptSerializer().Serialize(caseFolderObj);

            Console.WriteLine("Sending Case Folder...");
            string result1 = PostJson(caseFolderUrl, jsonCase, sessionCookie);
            Console.WriteLine("Case Folder Result:");
            Console.WriteLine(result1);

            // Build Document POST JSON
            var documentObj = new
            {
                ParentId = "DIGPI",
                Key = clientId + "-CONSENT.pdf",
                Name = "Consent document",
                ClassificationClassId = "",
                DocumentTypeId = "PRDCTRLT",
                Metadata = new
                {
                    Items = new object[]
                    {
                        new { DataType="Text", Key="CLNTID", Name="Client ID", Text=clientId },
                        new { DataType="Text", Key="NAME", Name="Name", Text=name },
                        new { DataType="Text", Key="SRNM", Name="Surname", Text=surname },
                        new { DataType="Text", Key="CLNTTYP", Name="Client type", Text="PI" },

                        new {
                            DataType="Composite",
                            Key="DCMTCDANDTTL",
                            Name="Document code and title",
                            Composite = new {
                                Items = new object[]
                                {
                                    new { DataType="Text", Key="CODE", Name="Code", Text="82" },
                                    new { DataType="Text", Key="TTL", Name="Title", Text="Standard information form for consumer credit" }
                                }
                            }
                        },

                        new { DataType="Text", Key="CNFONTLYLVL", Name="Confidentiality level", Text="Internal" },
                        new { DataType="Text", Key="STTS", Name="Status", Text="Active" },
                        new { DataType="Text", Key="CRTDBY", Name="Created by", Text="Viljete Kicaj" }
                    }
                },
                IsCaseFolder = "true",
                AllowedDocumentTypes = new string[] { "CLNT" },
                RenameIfExists = "true",
                OnBehalfOf = name + " " + surname,
                ReasonCode = "VPGL",
                ReasonBody = "Creating new case folder",
                ReasonType = "Lookup"
            };

            string jsonDoc = new JavaScriptSerializer().Serialize(documentObj);

            Console.WriteLine("Sending Document Metadata...");
            string result2 = PostJson(documentUrl, jsonDoc, sessionCookie);
            Console.WriteLine("Document Result:");
            Console.WriteLine(result2);
        }

        // ------------- HELPER METHODS --------------

        static string Authenticate(string url, string user, string pass)
        {
            try
            {
                string postData = $"username={user}&password={pass}";
                byte[] bytes = Encoding.UTF8.GetBytes(postData);

                var req = (HttpWebRequest)WebRequest.Create(url);
                req.Method = "POST";
                req.ContentType = "application/x-www-form-urlencoded";
                req.ContentLength = bytes.Length;

                using (var stream = req.GetRequestStream())
                    stream.Write(bytes, 0, bytes.Length);

                var resp = (HttpWebResponse)req.GetResponse();

                string cookie = resp.Headers["Set-Cookie"];
                return cookie;
            }
            catch (Exception ex)
            {
                Console.WriteLine("Auth error: " + ex.Message);
                return null;
            }
        }

        static string PostJson(string url, string json, string cookie)
        {
            try
            {
                byte[] bytes = Encoding.UTF8.GetBytes(json);

                var req = (HttpWebRequest)WebRequest.Create(url);
                req.Method = "POST";
                req.ContentType = "application/json";
                req.Headers.Add("Cookie", cookie);
                req.ContentLength = bytes.Length;

                using (var stream = req.GetRequestStream())
                    stream.Write(bytes, 0, bytes.Length);

                var resp = (HttpWebResponse)req.GetResponse();

                using (var reader = new StreamReader(resp.GetResponseStream()))
                    return reader.ReadToEnd();
            }
            catch (Exception ex)
            {
                return "Error: " + ex.Message;
            }
        }
    }
}